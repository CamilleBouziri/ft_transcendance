{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Player Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQNGGVAS8kaPYMCMZj4m2jxkH4QsE1RV9Jl3K5tPY0Fd6IT6H9TPHjXm" crossorigin="anonymous"> 
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">  
</head>
<body>

  <!-- ------------------------------------------------------------------------------- -->
  <!-- ----------------------------- SELECTEUR DE LANGUE ----------------------------- -->
  <!-- ------------------------------------------------------------------------------- -->

  <div class="language-switcher">
    <form action="{% url 'set_language' %}" method="post">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ request.path }}">
      <select name="language">
          <option value="fr" {% if LANGUAGE_CODE == 'fr' %}selected{% endif %}>FranÃ§ais</option>
          <option value="en" {% if LANGUAGE_CODE == 'en' %}selected{% endif %}>English</option>
          <option value="es" {% if LANGUAGE_CODE == 'es' %}selected{% endif %}>EspaÃ±ol</option>
      </select>
      <button type="submit">{% trans "OK" %}</button>
    </form>
  </div>

  <!-- ------------------------------------------------------------------------------- -->
  <!-- -------------------------------- PROFIL JOUEUR -------------------------------- -->
  <!-- ------------------------------------------------------------------------------- -->

  <section id="profile" class="header-section container">
      <div class="avatar">
        {% if user.avatar %}
          <img src="{{ user.avatar.url }}" alt="Avatar" style="width: 100px; height: 100px;">
        {% elif user.photo_url %}
          <img src="{{ user.photo_url }}" alt="Profile Picture">
        {% else %}
          <img src="{% static 'img/joueurs.png' %}" style="width: 100px; height: 100px;">
        {% endif %}
        <!-- <a href="{% url 'upload_avatar' %}" class="btn btn-secondary">{% trans "Change Avatar" %}</a> -->
      </div>
      <button onclick="window.location.href='{% url 'upload_avatar' %}'" class="btn2">{% trans "Change Avatar" %}</button>
      <div class="player-info">
        <h2>{{ user.nom }}
        <a href="{% url 'change_name' %}" class="btn btn-secondary" title="{% trans 'Edit Name' %}">
          <i class="fas fa-pencil-alt"></i> <!-- IcÃ´ne de crayon -->
        </h2>
      </a>
      <div class="progress-container">
          <div class="progress-bar" style="width: {{ level_progress }}%;"></div>
          <div class="progress-text"> Level {{ level }} - {{ level_progress }}%</div>
      </div>
      <a href="{% url 'logout' %}" class="logout-btn">{% trans "Logout" %} <span></span></a>       
  </section>
    

  <!-- ------------------------------------------------------------------------------- -->
  <!-- -------------------------------- BLOC PRINCIPAL ------------------------------- -->
  <!-- ------------------------------------------------------------------------------- -->
  
  <div class="main-content">
    
  <!-- ------------------------------------------------------------------------------- -->
  <!-- -------------------------------- COLONNE DROITE (Ã  gauche maintenant) ------------------------------- -->
  <!-- ------------------------------------------------------------------------------- -->

    <div class="right-column">
      <div class="buttons-container container">
        <a href="/amis/amis/" id="friend-btn" class="button-link"><span>ðŸ“²</span></a>
        <a href="{% url 'chat:conversations_list' %}" id="friend-btn" class="button-link"><span>ðŸ’¬</span></a>
        <button id="game-btn" class="button-link"><span>ðŸŽ²</span></button>
      </div>
        
  <!-- ------------------------------------------------------------------------------- -->
  <!-- -------------------------------- FENETRE POPUP -------------------------------- -->
  <!-- ------------------------------------------------------------------------------- -->

      <div id="game-popup" class="game-popup">
        <div class="popup-content">
          <h3>{% trans "Choose a Game" %}</h3>
          <a href="{% url 'start_game' %}">
            <button>{% trans "Pong" %}</button>
          </a>
          <a href="{% url 'create_morpion_match' %}">
            <button>{% trans "Morpion" %}</button>
          </a>
          <button id="close-popup" class="close-btn">âœ–</button>
        </div>
      </div>
      
      
      <script src="{% static 'Scripts/dashboard.js' %}"></script>

  <!-- ------------------------------------------------------------------------------- -->
  <!-- ------------------------------ TOURNOIS JOUEURS ------------------------------- -->
  <!-- ------------------------------------------------------------------------------- -->

      <div class="ten-cases container">
        <div class="achievement-title">
          <h2>{% trans "Tournaments" %}</h2>
          <div class="create-tournament-btn">
            <a href="{% url 'creer_tournois' %}" class="btn">
                {% trans "Create Tournament" %}
            </a>
          </div>
          <div class="highlight-bar"></div>
        </div>
        <div class="achievement-content">
          <table class="tournaments-table">
            <thead>
              <tr>
                <th>{% trans "Creator" %}</th>
                <th>{% trans "Status" %}</th>
                <th>{% trans "Players" %}</th>
                <th>{% trans "Actions" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for tournoi in tournois %}
                <tr class="tournament-row" data-url="{% url 'details_tournois' tournoi.id %}">
                  <td>{{ tournoi.createur.nom }}</td>
                  <td>{{ tournoi.get_statut_display }}</td>
                  <td>{{ tournoi.joueurs.count }}/4</td>
                  <td class="actions-cell">
                    {% if tournoi.est_complet %}
                      <p class="text-danger">{% trans "Tournament is full" %}</p>
                    {% elif user in tournoi.joueurs.all %}
                      <p class="text-success">{% trans "You have joined this tournament" %}</p>
                    {% else %}
                      <a href="{% url 'rejoindre_tournoi' tournoi.id %}" class="btn btn-primary" onclick="event.stopPropagation();">
                        {% trans "Join Tournament" %}
                      </a>
                    {% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4" class="empty-message">{% trans "No tournaments available at the moment." %}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
     <!-- Dans votre dashboard.html, vÃ©rifiez que cette section existe et est correctement placÃ©e -->
<div class="matches-section container">
  <div class="achievement-title">
    <h2>{% trans "Morpion Matches" %}</h2>
    <!-- <div class="create-tournament-btn">
      <a href="{% url 'create_morpion_match' %}" class="btn">
        {% trans "Create Match" %}
      </a>
    </div> -->
    <div class="highlight-bar"></div>
  </div>
  <div class="achievement-content">
    <table class="tournaments-table">
      <thead>
        <tr>
          <th>{% trans "Creator" %}</th>
          <th>{% trans "Status" %}</th>
          <th>{% trans "Players" %}</th>
          <th>{% trans "Actions" %}</th>
        </tr>
      </thead>
      <tbody>
        {% for match in morpion_matches %}
          <tr class="match-row" data-url="{% url 'morpion_match_detail' match.id %}">
            <td>{{ match.creator.nom }}</td>
            <td>{{ match.get_status_display }}</td>
            <td>{{ match.players.count }}/2</td>
            <td class="actions-cell">
              {% if match.is_full %}
                <p class="text-danger">{% trans "Match is full" %}</p>
              {% elif user in match.players.all %}
                <p class="text-success">{% trans "You have joined this match" %}</p>
              {% else %}
                <a href="{% url 'join_morpion_match' match.id %}" class="btn btn-primary" onclick="event.stopPropagation();">
                  {% trans "Join Match" %}
                </a>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="4" class="empty-message">{% trans "No Morpion matches available." %}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
    </div>
  
  <!-- ------------------------------------------------------------------------------- -->
  <!-- -------------------------------- COLONNE GAUCHE (Ã  droite maintenant) ------------------------------- -->
  <!-- ------------------------------------------------------------------------------- -->

    <div class="left-column">

      <div class="win-loss container">
        <div class="wins">
          {% trans "Wins" %}<br>
          <span class="number">{{ games_won }}</span>
        </div>
        <div class="losses">
          {% trans "Losses" %}<br>
          <span class="number">{{ games_lost }}</span>
        </div>
      </div>


      <section id="history" class="history-section container">
        <h2 style="font-size: 2em;">{% trans "History" %}</h2>
        <div class="highlight-bar"></div>
        <div class="history-list">
          {% for game in games %}
          <div class="match-date">
            ðŸ•’ {{ game.created_at|date:"M d, Y" }} - {{ game.created_at|time:"H:i" }}
          </div>
          <div class="history-item">
            <!-- Joueur 1 -->
              <div class="player {% if game.winner == user.nom %}winner{% else %}loser{% endif %}">
                {{ game.player1 }} {{ game.player1_score }}
              </div>
              <span>-</span>
              <!-- Joueur 2 -->
              <div class="player {% if game.winner == user.nom %}loser{% else %}winner{% endif %}">
                {{ game.player2_score }} {{ game.player2 }}
              </div>
            </div>
            <!-- Date et heure -->
          {% empty %}
            <p>{% trans "No games played yet." %}</p>
          {% endfor %}
        </div>
      </section>
    </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const tournamentRows = document.querySelectorAll('.tournament-row');
    tournamentRows.forEach(row => {
      row.addEventListener('click', function() {
        window.location.href = this.dataset.url;
      });
    });
    // Gestion des clics sur les lignes de matches de Morpion
    const matchRows = document.querySelectorAll('.match-row');
    matchRows.forEach(row => {
      row.addEventListener('click', function() {
        window.location.href = this.dataset.url;
      });
    });
  });
</script>

</body>
</html>
